{% load static %}


<!DOCTYPE html>
<html lang="no">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-W536FJFK9J"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-W536FJFK9J');
</script>
  <link rel="icon" href="{% static 'checker/favicon_io/favicon.ico' %}">
<link rel="icon" type="image/png" sizes="32x32" href="{% static 'checker/favicon_io/favicon-32x32.png' %}">
<link rel="icon" type="image/png" sizes="16x16" href="{% static 'checker/favicon_io/favicon-16x16.png' %}">
<link rel="apple-touch-icon" href="{% static 'checker/favicon_io/apple-touch-icon.png' %}">
<link rel="shortcut icon" href="{% static 'checker/favicon_io/favicon.ico' %}">

<link rel="manifest" href="{% static 'checker/favicon_io/site.webmanifest' %}">
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <title>Oikoluku & Kieliopin Tarkistus – Ilmainen Työkalu Verkossa</title>
 <meta name="description" content="Tarkista oikeinkirjoitus ja kielioppi ilmaiseksi suomeksi. Ei rekisteröitymistä. Nopea, tarkka ja helppo oikoluku suoraan selaimessa.">
 <link rel="stylesheet" href="{% static 'checker/main.css' %}">
</head>
<body>
 {% include "checker/header.html" %}


 <div class="wrap">
   <main class="card" id="korr">


     <div class="card__body">
      <header>
        <h1>Oikoluku ja kieliopin tarkistus suomeksi</h1>
        <p>
          Tarkista oikeinkirjoitus, kielioppi ja kirjoitusvirheet suomenkielisistä
          teksteistä helposti ja nopeasti tällä ilmaisella oikolukutyökalulla –
          suoraan selaimessa.
        </p>
      </header>
      </div>
      
      <div class="card__body">
        <form method="POST" id="form">
          {% csrf_token %}
      
          <div
            id="text-editor"
            class="editor"
            contenteditable="true"
            role="textbox"
            aria-multiline="true"
            spellcheck="false"
            placeholder="Liitä teksti tähän..."></div>
      
          <p id="length-error" class="length-error" hidden>
            Teksti on liian pitkä. Voit tarkistaa enintään 800 merkkiä kerrallaan.
          </p>
      
          <div class="meta" id="counter">
            <div class="counter" aria-live="polite">
              <span id="words">0</span> sanaa
              <span>·</span>
              <span id="chars">0</span> merkkiä
            </div>
          </div>
      
          <div class="actions">
            <button type="submit" id="submit" class="btn btn--primary">
              <span class="spinner" aria-hidden="true"></span>
              Tarkista teksti
            </button>
            <button class="btn btn--ghost" id="clear">Tyhjennä</button>
          </div>
        </form>
      </div>
      
      <div class="card__body">
        <section class="seo seo--rich" aria-labelledby="seo-title">
      
          <style>
            h1, h2, h3 { color: #2c3e50; }
            ul { padding-left: 20px; }
            li { margin-bottom: 10px; }
            blockquote {
              border-left: 4px solid #ccc;
              padding-left: 10px;
              color: #555;
              margin: 20px 0;
            }
          </style>
      
          <h1>Oikoluku ja kieliopin tarkistus suomeksi – ilmainen verkkotyökalu</h1>
      
          <p>
            Tämä ilmainen oikolukutyökalu auttaa sinua tarkistamaan oikeinkirjoituksen,
            kieliopin ja kirjoitusvirheet suomenkielisistä teksteistä nopeasti ja
            luotettavasti.
          </p>
      
          <hr>
      
          <h2>Tarkista oikeinkirjoitus ja kielioppi sekunneissa</h2>
          <p>
            Etsitkö helppoa tapaa suorittaa oikoluku ja kieliopin tarkistus suomeksi?
            Työkalu tunnistaa kirjoitusvirheet, kielioppivirheet, ylimääräiset
            välilyönnit sekä puuttuvat tai virheelliset välimerkit – täysin verkossa
            ilman asennuksia.
          </p>
      
          <ul>
            <li><strong>Oikeinkirjoituksen tarkistus:</strong> Yleisimmät kirjoitusvirheet ja sanamuodot</li>
            <li><strong>Kieliopin tarkistus:</strong> Rakenteelliset ja kielioppivirheet</li>
            <li><strong>Välimerkit ja typografia:</strong> Pilkut, pisteet ja muut virheet</li>
          </ul>
      
          <p>
            Lopputuloksena saat selkeämmän, virheettömän ja ammattimaisemman tekstin.
          </p>
      
          <hr>
      
          <h2>Mikä on oikolukutyökalu?</h2>
          <p>
            Oikolukutyökalu on tekoälypohjainen sovellus, joka analysoi tekstin
            kontekstia ja auttaa parantamaan oikeinkirjoitusta, kielioppia ja
            kirjoitustyyliä kokonaisuutena – ei vain yksittäisiä sanoja.
          </p>
      
          <p>
            Toisin kuin yksinkertaiset oikolukijat, tämä työkalu huomioi lauserakenteen,
            sanavalinnat ja kielen vivahteet.
          </p>
      
          <hr>
      
          <h2>Miksi tehdä oikoluku verkossa?</h2>
          <ul class="feature-list">
            <li><span class="check"></span><strong>Ei asennuksia</strong> – toimii suoraan selaimessa</li>
            <li><span class="check"></span><strong>Täysin ilmainen</strong> – ei rekisteröitymistä</li>
            <li><span class="check"></span><strong>Nopea ja tarkka</strong> – tulokset sekunneissa</li>
            <li><span class="check"></span><strong>Kaikille laitteille</strong> – tietokone, mobiili ja tabletti</li>
          </ul>
      
          <p>
            Työkalu sopii opiskelijoille, työelämän viestintään, sisällöntuottajille ja
            kaikille, jotka haluavat kirjoittaa suomea paremmin.
          </p>
      
          <hr>
      
          <h2>Aloita oikoluku nyt</h2>
          <p>
            Liitä tekstisi yläpuolella olevaan kenttään ja napsauta
            <strong>"Tarkista teksti"</strong>. Saat välittömästi selkeät
            korjausehdotukset.
          </p>
      
          <p>
            <strong>Ei tunnuksia. Ei maksuja. Vain sujuvaa ja korrektia suomen kieltä.</strong>
          </p>
      
          <hr>
      
          <blockquote>
            Valmis parantamaan tekstiäsi? Vieritä ylös ja kokeile oikolukutyökalua nyt!
          </blockquote>
      
        </section>
      </div>
      

      
     </div>


   </main>
 </div>

 <div id="tooltip-portal"></div>


 {% include "checker/footer.html" %}

<!-- LOGIN MODAL -->
<div class="modal" id="auth-modal" aria-hidden="true">
  <div class="modal__overlay"></div>
  <div class="modal__content" role="dialog" aria-modal="true">
 
 
    <button class="modal__close" id="auth-close" aria-label="Lukk">×</button>
 
 
    <h2 class="subheading">Logg inn</h2>
    <p class="sub">Du må være innlogget for å rette tekst.</p>
 
 
    <form method="post" action="{% url 'login' %}" class="auth-form">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.path }}">
   
      <div class="auth-fields">
        <input type="email" name="email" required placeholder="E-post" autocomplete="email">
        <input type="password" name="password" required placeholder="Passord" autocomplete="current-password">
      </div>
     
   
      <div class="auth-actions">
        <button class="btn btn--primary" type="submit">Logg inn</button>
     
        <button type="button" class="auth-link" id="open-register">
          Opprett konto
        </button>
      </div>
     
    </form>
   
 
 
  </div>
 </div>
 
 
 <!-- REGISTER MODAL -->
 <div class="modal" id="register-modal" aria-hidden="true">
  <div class="modal__overlay"></div>
  <div class="modal__content" role="dialog" aria-modal="true">
 
 
    <button class="modal__close" id="register-close" aria-label="Sulje">×</button>
 
 
    <h2 class="subheading" style="margin-top: 0px;">Luo tili</h2>
    <p class="sub">Luo tili, jotta voit korjata tekstiä.</p>
 
 
    <!-- Uses Django’s default UserCreationForm field names -->
    <form method="post" action="{% url 'register' %}" class="auth-form">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.path }}">
   
      <div class="auth-fields">
        <input type="text" name="name" required placeholder="Nimi" autocomplete="name">
        <input type="email" name="email" required placeholder="Sähköposti" autocomplete="email">
        <input type="password" name="password" required placeholder="Salasana" autocomplete="new-password">
      </div>
     
   
      <div class="auth-actions">
        <button class="btn btn--primary" type="submit">Luo tili</button>
        <button type="button" class="auth-link" id="open-login">
          Minulla on jo tili
        </button>
              </div>

 
   </form>
  


 </div>
</div>

<!-- PAYMENT MODAL -->
<div id="paymentModal" class="pay-modal" role="dialog" aria-modal="true"
     aria-labelledby="pay-modal-title" aria-describedby="pay-modal-desc" hidden>
  <div class="pay-modal__overlay" data-close-modal></div>

  <div class="pay-modal__content pay-modal__content--wide" role="document">
    <button class="pay-modal__close" aria-label="Sulje">
      &times;
    </button>

    <div class="pay-modal__badge" aria-hidden="true">
      30 päivän ilmainen kokeilu
    </div>

    <h2 id="pay-modal-title">Saat täyden käyttöoikeuden Oikoluku Prohon</h2>

    <p id="pay-modal-desc" class="pay-modal__subtext">
      Saat täyden käyttöoikeuden Oikoluku Prohon 30 päivän ajaksi täysin ilmaiseksi.
      Kokeilujakson jälkeen tilaus jatkuu hintaan 5,99 € kuukaudessa.
      Sinulta ei veloiteta mitään, jos peruutat tilauksen ennen 30 päivän kokeilujakson päättymistä.
    </p>

    <button class="pay-modal__cta" id="start-checkout">
      Aloita ilmainen kokeilu
    </button>
  </div>
</div>


<style>
  /* Modal sizing */
 /* Center modal vertically + horizontally */
 .modal{
  position: fixed;
  inset: 0;
  display: none;        /* hidden by default */
  z-index: 1000;
  padding: 24px;
 }
 
 
 .modal.active{
  display: flex;        /* ONLY show when active */
  align-items: center;
  justify-content: center;
 }
 
 
 
 
 /* Make overlay cover full screen behind content */
 .modal__overlay{
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,.45);
  backdrop-filter: blur(3px);
 }
 
 
 /* Your sizing stays, just remove any margin-based centering */
 .modal__content{
  position: relative;
  max-width: 560px;
  width: 100%;
  padding: 30px 32px;
  border-radius: 16px;
  background: #fff;
  box-shadow: 0 20px 40px rgba(0,0,0,.2);
 }
 
 
 /* Center modal title + subtitle */
 .modal__content h2,
 .modal__content .sub{
  text-align: center;
 }
 
 
 .sub{
  margin-bottom: 30px;
 }
 
 
 .subheading{
  margin-bottom: 0px;
 }
 
 
 /* Layout */
 .auth-form{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap: 20px;
 }
 
 
 /* spacing BETWEEN fields only */
 .auth-fields{
  display:flex;
  flex-direction:column;
  gap:14px;
  width:100%;
  align-items:center;
 }
 
 
 /* spacing BETWEEN buttons only */
 .auth-actions{
  display:flex;
  flex-direction:column;
  gap:8px;
  margin-top:14px;
  width:100%;
  align-items:center;
 }
 
 
 /* shared width */
 .auth-fields input,
 .auth-actions .btn{
  width:450px;
  max-width:100%;
 }
 
 
 /* ✅ Modern input styling */
 .auth-fields input{
  appearance:none;
  -webkit-appearance:none;
  height:46px;
  padding:0 14px;
  border:1.5px solid #cbd5e1;
  border-radius:12px;
  background:#f9fafb;
  color:var(--text);
  font-size:15px;
  line-height:1;
  outline:none;
  transition: border-color .15s ease, box-shadow .15s ease, background-color .15s ease;
 }
 
 
 .auth-fields input::placeholder{
  color:#6b7280;
  opacity: 1;
 }
 
 
 .auth-fields input:focus{
  background:#fff;
  border-color: color-mix(in oklab, var(--accent), #fff 30%);
  box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent), #fff 82%);
 }
 
 
 /* Optional: nicer autofill */
 .auth-fields input:-webkit-autofill{
  -webkit-text-fill-color: var(--text);
  box-shadow: 0 0 0 1000px #f9fafb inset;
  transition: background-color 9999s ease-out 0s;
 }
 .auth-fields input:-webkit-autofill:focus{
  box-shadow:
    0 0 0 1000px #fff inset,
    0 0 0 4px color-mix(in oklab, var(--accent), #fff 82%);
 }
 
 
 /* Keep your modal buttons clean (no bottom "stripe") */
 .modal .btn--primary{
  box-shadow:none;
 }
 
 
 .modal__close{
  position:absolute;
  top:14px;
  right:14px;
  width:38px;
  height:38px;
  display:grid;
  place-items:center;
  border:1px solid #e5e7eb;
  border-radius:999px;
  background:rgba(249,250,251,.95);
  color:#111827;
  font-size:18px;
  line-height:1;
  cursor:pointer;
  transition: background-color .15s ease, border-color .15s ease, box-shadow .15s ease, transform .02s ease;
 }
 
 
 .modal__close:hover{
  background:#fff;
  border-color:#cbd5e1;
  box-shadow:0 8px 20px rgba(17,24,39,.12);
 }
 
 
 .modal__close:active{
  transform:translateY(1px);
 }
 
 
 .modal__close:focus-visible{
  outline:none;
  box-shadow:0 0 0 4px color-mix(in oklab, var(--accent), #fff 82%);
  border-color: color-mix(in oklab, var(--accent), #fff 30%);
 }
 
 
 .auth-link{
  background:none;
  border:none;
  padding:0;
  margin-top:10px;
  color: var(--accent);
  font-weight:600;
  font-size:14px;
  line-height:1.2;
  cursor:pointer;
  text-decoration:none;
  transition: opacity .15s ease, transform .02s ease;
 }
 
 
 .auth-link:hover{
  text-decoration:underline;
  text-underline-offset:3px;
 }
 
 
 .auth-link:active{
  transform:translateY(1px);
 }
 
 
 .auth-link:focus-visible{
  outline:none;
  box-shadow:0 0 0 4px color-mix(in oklab, var(--accent), #fff 82%);
  border-radius:8px;
  padding:4px 8px;
  margin-top:6px;
 }
 
 
 .seo.seo--rich{
   margin-top: 8px;
   padding-top: 6px;
   color: var(--text);
 }
 
 .seo.seo--rich h2{
   margin: 0 0 10px;
   font-size: 1.25rem;
   letter-spacing: .2px;
 }
 
 .seo.seo--rich h3{
   margin: 18px 0 8px;
   font-size: 1.05rem;
   letter-spacing: .15px;
 }
 
 .seo.seo--rich p{
   margin: 10px 0;
   color: var(--text);
   max-width: 80ch;
 }
 
 .seo.seo--rich ul{
   margin: 10px 0 12px;
   padding-left: 18px;
   display: grid;
   gap: 8px;
   max-width: 80ch;
 }
 
 .seo.seo--rich li{
   color: var(--text);
 }
 
 .seo-checklist{
   list-style: none;
   padding-left: 0;
 }
 
 .seo-checklist li{
   position: relative;
   padding-left: 26px;
 }
 
 .seo-checklist li::before{
   content: "✓";
   position: absolute;
   left: 0;
   top: 0;
   color: var(--accent);
   font-weight: 800;
 }
 
 .seo-tool-slot{
   margin-top: 14px;
   padding: 12px 14px;
   border: 1px dashed color-mix(in oklab, var(--accent), var(--border) 55%);
   border-radius: 12px;
   background: color-mix(in oklab, var(--accent), #fff 92%);
   color: color-mix(in oklab, var(--accent), #000 35%);
   font-weight: 600;
   max-width: 80ch;
 }
 
 
 #text-editor .error {
   display: inline-block;
   cursor: pointer;
   border-radius: 3px;
   padding: 0 2px;
   background: rgba(239, 68, 68, 0.18);
   box-shadow: inset 0 -2px 0 rgba(239, 68, 68, 0.95);
   text-decoration: none;
 }
 

 .feature-list {
  list-style: none;
  padding: 0;
}

.feature-list li {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  margin-bottom: 10px;
}

.feature-list .check {
  width: 16px;
  height: 16px;
  margin-top: 4px;
  position: relative;
  flex-shrink: 0;
}

.feature-list .check::after {
  content: "";
  position: absolute;
  left: 3px;
  top: 1px;
  width: 6px;
  height: 10px;
  border: solid currentColor;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}


 
 /* --- FORCE MAIN CONTENT CENTERING (SAFE, NON-DESTRUCTIVE) --- */
 main,
 main > .wrap,
 body > .wrap{
   margin-inline: auto;
 }

 /* ===== Payment Modal (scoped) ===== */
:root {
  --pm-overlay: rgba(17, 24, 39, 0.6);
  --pm-bg: #ffffff;
  --pm-text: #0f172a;
  --pm-muted: #475569;

  --pm-primary: #057e6f;
  --pm-primary-hover: #04695d;

  --pm-ring: 0 0 0 3px rgba(5, 126, 111, 0.30);
  --pm-radius: 14px;
  --pm-shadow: 0 12px 40px rgba(2, 6, 23, 0.25);
}

.pay-modal[hidden] { display: none !important; }

.pay-modal {
  position: fixed;
  inset: 0;
  z-index: 1000;
  display: grid;
  place-items: center;
  padding: 24px;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
  color: var(--pm-text);
}

.pay-modal__overlay {
  position: absolute;
  inset: 0;
  background: var(--pm-overlay);
  backdrop-filter: blur(2px);
}

.pay-modal__content {
  position: relative;
  width: min(560px, 100%);
  background: var(--pm-bg);
  border-radius: var(--pm-radius);
  box-shadow: var(--pm-shadow);
  padding: 28px 24px 24px;
  transform: translateY(10px);
  opacity: 0;
  animation: pm-in 220ms ease-out forwards;
}

.pay-modal__content--wide {
  max-width: 560px;
}

@keyframes pm-in {
  to { transform: translateY(0); opacity: 1; }
}

.pay-modal__close {
  position: absolute;
  top: 10px;
  right: 12px;
  width: 36px;
  height: 36px;
  border: 0;
  background: transparent;
  color: #334155;
  font-size: 24px;
  line-height: 1;
  border-radius: 9px;
  cursor: pointer;
}

.pay-modal__close:hover { background: #f1f5f9; }
.pay-modal__close:focus-visible { outline: none; box-shadow: var(--pm-ring); }

.pay-modal__badge {
  display: inline-block;
  margin-bottom: 10px;
  padding: 6px 10px;
  font-size: 12px;
  font-weight: 600;
  color: var(--pm-primary);
  background: #e9f8f6;
  border: 1px solid #b4e8df;
  border-radius: 999px;
}

.pay-modal h2 {
  margin: 4px 0 8px;
  font-size: 22px;
  line-height: 1.25;
}

.pay-modal__subtext {
  margin: 0 0 18px;
  color: var(--pm-muted);
  font-size: 15px;
  line-height: 1.55;
}

.pay-modal__cta {
  width: 100%;
  border: 0;
  border-radius: 10px;
  background: var(--pm-primary);
  color: #fff;
  padding: 14px 16px;
  font-weight: 700;
  font-size: 16px;
  cursor: pointer;
  box-shadow: 0 8px 18px rgba(5,126,111,0.25);
}

.pay-modal__cta:hover { background: var(--pm-primary-hover); }
.pay-modal__cta:focus-visible { outline: none; box-shadow: var(--pm-ring); }


#tooltip-portal {
  position: fixed;
  z-index: 9999;
  background: #111827;
  color: #fff;
  padding: 10px 12px;
  border-radius: 8px;
  box-shadow: 0 10px 25px rgba(0,0,0,.25);
  font-size: 14px;
  line-height: 1.4;
  display: none;
  pointer-events: auto;
}

#tooltip-portal.visible {
  display: block;
}

#tooltip-portal .actions {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}

#tooltip-portal button {
  background: #fff;
  color: #111;
  border: 0;
  border-radius: 6px;
  padding: 4px 8px;
  font-size: 13px;
  cursor: pointer;
}

 </style>
<script>
  (function () {
    console.log("✅ main.js loaded");
  
    /* ===============================
       GLOBAL STATE
    =============================== */
    let appliedCorrections = 0;
    const FREE_CORRECTIONS = 1;
  
    window.IS_AUTHENTICATED = {{ request.user.is_authenticated|yesno:"true,false" }};
  
    const MAX_WORDS = 800;
  
    /* ===============================
       HELPERS
    =============================== */
    function countWords(text) {
      return (text.trim().match(/\S+/g) || []).length;
    }
  
    function escapeHTML(str) {
      return (str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }
  
    function htmlWithNewlines(str) {
      return escapeHTML(str).replace(/\n/g, "<br>");
    }
  
    /* ===============================
       DOM REFERENCES
    =============================== */
    const $ = (s, scope = document) => scope.querySelector(s);
  
    const editor   = $("#text-editor");
    const wordsEl  = $("#words");
    const charsEl  = $("#chars");
    const form     = $("#form");
    const submit   = $("#submit");
    const clearBtn = $("#clear");
    const errorEl  = $("#length-error");
    const tooltip  = document.getElementById("tooltip-portal");
  
    if (!editor || !form || !tooltip) return;
  
    /* ===============================
       TEXT STATE
    =============================== */
    let lastPlainText = "";
    let CURRENT_DIFFS = [];
    let activeError = null;
  
    /* ===============================
       COUNTERS & LIMIT
    =============================== */
    function updateCounts(text) {
      const t = text || "";
      wordsEl.textContent = (t.trim().match(/\S+/g) || []).length;
      charsEl.textContent = t.length;
    }
  
    function enforceLengthLimit(text) {
      const tooLong = countWords(text) > MAX_WORDS;
      submit.disabled = tooLong;
      editor.classList.toggle("is-too-long", tooLong);
      if (errorEl) errorEl.hidden = !tooLong;
    }
  
    function getPlainText() {
      return (editor.innerText || "").replace(/\u00A0/g, " ");
    }
  
    /* ===============================
       DIFF LOGIC
    =============================== */
    function tokenizeWords(text) {
      const regex = /\p{L}+[.,;:!?]?/gu;
      const tokens = [];
      let m;
      while ((m = regex.exec(text))) {
        tokens.push({
          word: m[0],
          start: m.index,
          end: m.index + m[0].length,
        });
      }
      return tokens;
    }
  
    function getWordDiffs(original, corrected) {
      const o = tokenizeWords(original);
      const c = tokenizeWords(corrected);
      const diffs = [];
  
      for (let i = 0; i < Math.min(o.length, c.length); i++) {
        if (o[i].word !== c[i].word) {
          diffs.push({
            start: o[i].start,
            end: o[i].end,
            original: o[i].word,
            suggestion: c[i].word,
          });
        }
      }
      return diffs;
    }
  
    function buildHighlightedHTML(text, diffs) {
      if (!diffs.length) return htmlWithNewlines(text);
  
      let html = "";
      let last = 0;
  
      diffs.forEach((d, i) => {
        html += htmlWithNewlines(text.slice(last, d.start));
        html += `<span class="error" data-diff-index="${i}">${escapeHTML(
          text.slice(d.start, d.end)
        )}</span>`;
        last = d.end;
      });
  
      html += htmlWithNewlines(text.slice(last));
      return html;
    }
  
    /* ===============================
       TOOLTIP POSITION
    =============================== */
    function positionTooltip(error) {
      tooltip.style.display = "block";
      tooltip.style.visibility = "hidden";
  
      const w = error.getBoundingClientRect();
      const t = tooltip.getBoundingClientRect();
      const GAP = 12;
  
      let top = w.top - t.height - GAP;
      if (top < 8) top = w.bottom + GAP;
  
      let left = w.left + w.width / 2;
      left = Math.max(t.width / 2 + 8, Math.min(window.innerWidth - t.width / 2 - 8, left));
  
      tooltip.style.top = `${top}px`;
      tooltip.style.left = `${left}px`;
      tooltip.style.transform = "translateX(-50%)";
      tooltip.style.visibility = "visible";
      tooltip.classList.add("visible");
    }
  
    /* ===============================
       ERROR CLICK
    =============================== */
    editor.addEventListener("click", (e) => {
      const error = e.target.closest(".error");
      if (!error) return;
  
      if (appliedCorrections >= FREE_CORRECTIONS) {
        if (!window.IS_AUTHENTICATED) {
          window.openRegisterModal?.();
          return;
        }
        if (!window.IS_PAYING) {
          window.openPaymentModal?.();
          return;
        }
      }
  
      activeError = error;
      const diff = CURRENT_DIFFS[Number(error.dataset.diffIndex)];
      if (!diff) return;
  
      tooltip.innerHTML = `
        <div class="suggestion">${escapeHTML(diff.suggestion)}</div>
        <div class="actions">
          <button type="button" class="apply">Käytä</button>
          <button type="button" class="dismiss">Hylkää</button>
        </div>
      `;
  
      positionTooltip(error);
    });
  
    /* ===============================
       APPLY / DISMISS
    =============================== */
    document.addEventListener(
      "click",
      (e) => {
        const applyBtn = e.target.closest("#tooltip-portal .apply");
        const dismissBtn = e.target.closest("#tooltip-portal .dismiss");
        if (!applyBtn && !dismissBtn) return;
        if (!activeError) return;
  
        e.preventDefault();
        e.stopPropagation();
  
        const diff = CURRENT_DIFFS[Number(activeError.dataset.diffIndex)];
        if (!diff) return;
  
        if (applyBtn) {
          activeError.replaceWith(document.createTextNode(diff.suggestion));
          appliedCorrections += 1;
        } else {
          activeError.replaceWith(document.createTextNode(diff.original));
        }
  
        lastPlainText = getPlainText();
        sessionStorage.setItem("tc_text", lastPlainText);
        updateCounts(lastPlainText);
  
        tooltip.classList.remove("visible");
        tooltip.style.display = "none";
        activeError = null;
      },
      true
    );
  
    /* ===============================
       INIT
    =============================== */
    const saved = sessionStorage.getItem("tc_text");
    if (saved) {
      lastPlainText = saved;
      editor.innerHTML = htmlWithNewlines(saved);
    }
    updateCounts(lastPlainText);
  
    /* ===============================
       INPUT
    =============================== */
    editor.addEventListener("input", () => {
      lastPlainText = getPlainText();
      sessionStorage.setItem("tc_text", lastPlainText);
      updateCounts(lastPlainText);
      enforceLengthLimit(lastPlainText);
    });
  
    clearBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      editor.innerHTML = "";
      lastPlainText = "";
      sessionStorage.removeItem("tc_text");
      updateCounts("");
    });
  
    /* ===============================
       SUBMIT
    =============================== */
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = lastPlainText.trim();
      if (!text) return;
  
      if (countWords(text) > MAX_WORDS) {
        enforceLengthLimit(text);
        return;
      }
  
      submit.disabled = true;
      submit.classList.add("is-loading");
  
      try {
        const res = await fetch("/", {
          method: "POST",
          headers: {
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: new URLSearchParams({ text }),
        });
  
        const data = await res.json();
        if (!res.ok) return;
  
        CURRENT_DIFFS = data.differences || [];
        editor.innerHTML = buildHighlightedHTML(data.original_text, CURRENT_DIFFS);
        lastPlainText = data.original_text;
  
        sessionStorage.setItem("tc_text", lastPlainText);
        updateCounts(lastPlainText);
      } finally {
        submit.disabled = false;
        submit.classList.remove("is-loading");
      }
    });
  })();
  </script>
  